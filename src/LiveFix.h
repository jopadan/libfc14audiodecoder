// The soundtrack modules from the game "Chambers of Shaolin"
// as included with Future Composer v1.2 and v1.3 in SMOD format
// are broken, but have been copied into many module collections.

// Fix "SMOD.Chambers_of_Shaolin_2" (aka "Test of the Stick").
// Also included in "fcm.shaolin.2-4" and "mod.shaolin.2-4".
//
// The drums in various patterns are misplaced! Correcting the pattern
// data is strictly required as to make it sound right. There is
// nothing else a FC player could do about it.
bool LiveFixShaolin2 = false;
if ( !LiveFixShaolin2 ) {
    const ubyte pattOrig02[PATTERN_LENGTH] = {
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x01, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00,
        0x0c, 0x03, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x01, 0x00, 0x00,
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x01, 0x00, 0x00, 0x0c, 0x01, 0x00, 0x00,
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x03, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x03, 0x00, 0x00
    };
    const ubyte pattOrig07[PATTERN_LENGTH] = {
        0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00
    };
    const ubyte pattOrig08[PATTERN_LENGTH] = {
        0x0c, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02,
        0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a,
        0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02
    };
    const ubyte pattOrig18[PATTERN_LENGTH] = {
        0x0c, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02,
        0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x13, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00
    };
    // copied from Jochen Hippel's TFMX module
    const ubyte pattTFMX02[PATTERN_LENGTH] = {
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x01, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00,
        0x0c, 0x03, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x01, 0x00, 0x00,
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x01, 0x0c, 0x01, 0x0c, 0x01, 0x00, 0x00,
        0x0c, 0x03, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x03, 0x00, 0x00, 0x0c, 0x03, 0x0c, 0x03
    };
    const ubyte pattTFMX07[PATTERN_LENGTH] = {
        0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x0c, 0x02, 0x13, 0x03, 0x00, 0x00
    };
    const ubyte pattTFMX08[PATTERN_LENGTH] = {
        0x0c, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x0c, 0x02, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x0c, 0x02, 0x0c, 0x03, 0x00, 0x00
    };
    const ubyte pattTFMX18[PATTERN_LENGTH] = {
        0x0c, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x0c, 0x02, 0x00, 0x00,
        0x0c, 0x02, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x02, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00
    };
    if ( havePattern(0x2,pattOrig02) && havePattern(0x7,pattOrig07) &&
         havePattern(0x8,pattOrig08) && havePattern(0x18,pattOrig18) ) {
        replacePattern(0x02,pattTFMX02);
        replacePattern(0x07,pattTFMX07);
        replacePattern(0x08,pattTFMX08);
        replacePattern(0x18,pattTFMX18);
        LiveFixShaolin2 = true;  // as to reuse this
#ifdef DEBUG
        cout << "FIX APPLIED: Chambers of Shaolin 2" << endl;
#endif
    }
}

// Fix "SMOD.Chambers_of_Shaolin_3" (aka "Test of Fire").
// Also included in "fcm.shaolin.2-4" and "mod.shaolin.2-4".
//
// The drums in pattern 0x24 are misplaced! Correcting the pattern
// data is strictly required as to make it sound right. There is
// nothing else a FC player could do about it.
bool LiveFixShaolin3 = false;
if ( !LiveFixShaolin3 ) {
    const ubyte pattOrig[PATTERN_LENGTH] = {
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x18, 0x0c, 0x00, 0x00,
        0x0c, 0x0c, 0x00, 0x00, 0x0a, 0x03, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x0a, 0x01, 0x00, 0x00,
        0x0a, 0x0c, 0x00, 0x00, 0x0f, 0x0c, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x11, 0x0c, 0x00, 0x00,
        0x0c, 0x0c, 0x00, 0x00, 0x13, 0x0c, 0x00, 0x00, 0x14, 0x03, 0x00, 0x00, 0x14, 0x0c, 0x00, 0x00
    };
    const ubyte pattFixed[PATTERN_LENGTH] = {
        0x0c, 0x01, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x18, 0x0c, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00,
        0x0a, 0x03, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x0a, 0x01, 0x00, 0x00, 0x0f, 0x0c, 0x00, 0x00,
        0x0c, 0x0c, 0x00, 0x00, 0x11, 0x0c, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x13, 0x0c, 0x00, 0x00,
        0x14, 0x03, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x11, 0x0c, 0x00, 0x00, 0x0f, 0x0c, 0x00, 0x00
    };
    // copied from Jochen Hippel's TFMX module
    const ubyte pattTFMX[PATTERN_LENGTH] = {
        0x0c, 0x01, 0x0c, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0x18, 0x0c, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00,
        0x0a, 0x03, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x0a, 0x01, 0x0a, 0x0c, 0x0f, 0x0c, 0x00, 0x00,
        0x0c, 0x0c, 0x00, 0x00, 0x11, 0x0c, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x13, 0x0c, 0x00, 0x00,
        0x14, 0x03, 0x14, 0x0c, 0x0c, 0x0c, 0x00, 0x00, 0x11, 0x0c, 0x00, 0x00, 0x0f, 0x0c, 0x0f, 0x0c
    };
    if ( havePattern(0x24,pattOrig) ) {
        replacePattern(0x24,pattFixed);
        LiveFixShaolin3 = true;  // as to reuse this below
#ifdef DEBUG
        cout << "FIX APPLIED: Chambers of Shaolin 3" << endl;
#endif
    }
}
// The data in this pattern make no sense:
//  - instrument 0x28 (0x20+ST(8)) is empty,
//    and actually instruments 0x18 to 0x29 are empty
//  - the value 0x8c looks misplaced, because notes are 7-bit values
//  - whereas the original soundtrack activates portamento in this pattern,
//    portamento is completely missing here
if ( LiveFixShaolin3 ) {
    const ubyte pattOrig[PATTERN_LENGTH] = {
        0x0a, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    const ubyte pattFixed[PATTERN_LENGTH] = {
        0x09, 0x80, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    if ( havePattern(0x25,pattOrig) ) {
        replacePattern(0x25,pattFixed);
#ifdef DEBUG
        cout << "FIX APPLIED: Chambers of Shaolin 3" << endl;
#endif
    }
}

// FIX "SMOD.Chambers_of_Shaolin_5" (aka "Test of Balance").
// Also included in "fcm.shaolin.5-6" and "mod.shaolin.5-6".
//
// What happens here is that at step 0x33 of the track table, the third
// channel not only changes to an empty pattern (which is not used anywhere
// else) but also resets transpose from 0xef to 0, which is audibly wrong.
// Since such a change of PT/TR is legal, the player cannot ignore it
// without breaking compatibility with other SMOD/FC14 modules.
bool LiveFixShaolin5 = false;
if ( !LiveFixShaolin5 ) {
    const ubyte pattOrig1a[PATTERN_LENGTH] = {
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    };
    const ubyte pattFixed1a[PATTERN_LENGTH] = {
  0x2a,0x20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0x10
    };
    const ubyte pattOrig17[PATTERN_LENGTH] = {
     0x24,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
        0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
    };
    if ( havePattern(0x1a,pattOrig1a) && havePattern(0x17,pattOrig17) ) {

        const int t = 2*TRACKTAB_ENTRY_LENGTH;
        const ubyte trackTabOrig[t] = {
            0x12, 0x0c, 0x04, 0x14, 0xf4, 0x00, 0x1a, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00,
            0x16, 0x0c, 0x04, 0x15, 0xf4, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00
        };
        const ubyte trackTabFixed[t] = {
            0x12, 0x0c, 0x04, 0x14, 0xf4, 0x00, 0x17, 0x07, 0x0c, 0x00, 0x00, 0x00, 0x00,
            0x16, 0x0c, 0x04, 0x15, 0xf4, 0x00, 0x00, 0x07, 0x0c, 0x00, 0x00, 0x00, 0x00
        };
        udword trackTabPos = _admin.offsets.trackTable+(0x33*TRACKTAB_ENTRY_LENGTH);
        if ( memcmp(input+trackTabPos,&trackTabOrig,t) == 0 ) {
            // Replace the bad/dubious track table entries.
            memcpy(input+trackTabPos,&trackTabFixed,t);
#ifdef DEBUG
            cout << "FIX APPLIED: Chambers of Shaolin 5" << endl;
#endif
        }
    }
}
